## 互联网的组成

- 网络边缘
    - 应用程序,端系统
- 网络核心
    - 路由器
    - 网络的网络
- 接入网,物理介质
    - 通信链路

![image-20200112152321577](https://cy-1256894686.cos.ap-beijing.myqcloud.com/cy/2020-01-12-072322.png)

![image-20200112152329839](https://cy-1256894686.cos.ap-beijing.myqcloud.com/cy/2020-01-12-072330.png)

![image-20200112152145835](https://cy-1256894686.cos.ap-beijing.myqcloud.com/cy/2020-01-12-072146.png)

􏰉􏰊􏱻![image-20200112151948789](https://cy-1256894686.cos.ap-beijing.myqcloud.com/cy/2020-01-12-071949.png)

带宽

􏳟􏳠􏳡􏱍􏳢􏱭􏳣􏳤􏱧􏰇􏱩􏳚􏳥􏳦􏳧数字信号在特定链路上的传输速度（bit/s)

![image-20200112152054848](https://cy-1256894686.cos.ap-beijing.myqcloud.com/cy/2020-01-12-072054.png)

![image-20200112152130319](https://cy-1256894686.cos.ap-beijing.myqcloud.com/cy/2020-01-12-072131.png)





## [*IPv4* 地址终于*用完*了，会有什么影响？](https://zhuanlan.zhihu.com/p/93902828)



## 802.11的隐藏节点和RTS/CTS机制(一)



![image-20200114181402261](/Users/Macbook/Library/Application%20Support/typora-user-images/image-20200114181402261.png)

![image-20200114181411667](/Users/Macbook/Library/Application%20Support/typora-user-images/image-20200114181411667.png)

![image-20200114182504177](/Users/Macbook/Library/Application%20Support/typora-user-images/image-20200114182504177.png)











----

开放大题:举出几个你在使用因特网时所遇到的问题，并用你所学到的知识分析该问题所产生的原因和解决方法。

## 移动端300ms延迟的前世今生

下载速度和上传速度快，并不代表网络，网络延迟以及数据丢包正常，就比如移动100M，下载速度可以，平均达到15M每秒，上传速度4M每秒左右，但是网络延迟100毫秒到200毫秒之间，尤其是数据就报百分之50到60%之间，对比中国电信100M宽带，下载速度平均10M每秒，上传速度平均1M每秒左右，但是网络延迟不会超过60毫秒，数据丢包没有超过10%这就是网络优化的问题
所以下载速度和上传速度，并不能代表网络质量，以及连接游戏之后，网络优化性
还有就是你所使用的无线路由器，可以通过重置无线路由器，开启dhcp功能，设置合理的IP地址池范围，对IP地址进行过滤管理，尝试解决网络，连接问题，当然你也可以通过用网线直接连接光纤猫，用来排除无线路由器造成的网络延迟问题，以及确定宽带网络本身优化性问题，就是网络延迟和数据丢包，以及使用第三方网络优化软件，比如网易uu等，网络加速软件对宽带网络进行优化，再来体验游戏

如何减小网络延时?

如何定义网络延迟程度：

（网络延迟PING值越低速度越快）

1~30ms：极快，几乎察觉不出有延迟，玩任何游戏速度都特别顺畅

31~50ms：良好，可以正常游戏，没有明显的延迟情况

51~100ms：普通，对抗类游戏能感觉出明显延迟，稍有停顿

\>100ms：差，无法正常游戏，有卡顿，丢包并掉线现象

[为*降低延迟*时间，4G LTE *网络*采用了什么方法？](https://www.zhihu.com/question/19553283/answer/29752814)

首先是网络架构扁平化，去掉RNC的物理实体，功能实体分解到基站和核心网元大部分功能放在了E-NodeB，以减少时延和增强调度能力。

其次，对于4G中的语音业务（延时敏感业务中的一种），4G不再基于CS交换，而是PS交换，通过IMS系统来保证延迟。

![img](https://cy-1256894686.cos.ap-beijing.myqcloud.com/cy/2020-01-12-063221.jpg)

**同步机制**

假设游戏中A,B两个玩家移动，并同时向对方发出射击指令
如果没有合适的同步机制
那么可能出现的情况有
1 A屏幕显示B已经被杀死，B屏幕显示A已经被杀死
2 或者在瞄准后确打不到对方
图中玩家Plyaer1,Plyaer2在两个不同的客户端，表现出不同效果

![img](https://cy-1256894686.cos.ap-beijing.myqcloud.com/cy/2020-01-12-063330.png)



因为网络是有延时的，而每个玩家的网络情况都不尽相同。
还有每帧渲染的延迟（早期的计算机性能不够好的时候会出现这个问题）
同步机制最重要的作用就是解决延迟等可能发生不一致的情况。

**同步机制的分类**
**Peer-to-peer模式**: 没有服务器，每个玩家互相连接，各自模拟整个流程.典型的lockstep模式
优点：减少主机带来的延时
缺点：容易作弊

![img](https://cy-1256894686.cos.ap-beijing.myqcloud.com/cy/2020-01-12-063335.png)


**Client-Server模式**所有的操作需经过服务器确认后才能进行客户端模拟，如arpg传奇类都是此架构，如果延时高就会有明显的卡顿。优点：服务器是绝对的权威，可以防止作弊，可以做更多的管理与限制缺点：服务器变的更复杂，服务器断线，所有玩家断线，属于服务器依赖型。



![img](https://cy-1256894686.cos.ap-beijing.myqcloud.com/cy/2020-01-12-063333.png)



早期的RTS游戏大多采用Lockstep方案来设计，像罗马帝国，沙丘之类。
Lockstep最早用于军队中

![img](https://cy-1256894686.cos.ap-beijing.myqcloud.com/cy/2020-01-12-063331.png)


就是说玩家的数据每个时间段同步一次，同步的走。

**什么是Turn?**
一个turn可以理解成1个回合，相信大家都玩过回合制游戏吧
只是这个turn非常短，大概100MS-200MS
玩家相互之间发送的指令在每个turn间隔发出



![img](https://cy-1256894686.cos.ap-beijing.myqcloud.com/cy/2020-01-12-063334.png)

每个玩家只需要接收指令，并在本地播放指令就可以啦

---

## 实现内网穿透的原理

在我国，由于网民众多，运营商无法保证为每一个宽带用户提供全球唯一的公网IPv4地址。因此很多用户会发现通过路由器端查看到的WAN端IP与百度“IP”关键词所得到的IP不一致，并且前者的IP为一个私有IP。

而还有一些情况下，公网IP比较昂贵，企业虽然本身也持有少量的独立的公网IP，但是由于成本限制无法为企业内每一台主机都提供一个公网IP，或者内网并不是所有服务都需要暴露到公网中进行访问，那么企业有可能就会使用NAT技术将大量的内网IP通过一定规则映射到公网IP上。而最常见的其中一种技术就是NAPT，也叫“网络端口地址转换”。因为一般一个服务都是通过一个端口来提供，因此通过这种方式可以将特定的服务通过特定的规则开放到少量的公网IP上。

## 问题

但是有的时候我们个人宽带用户也想将自己的服务发布到公网IP上。比如说我们做了一个很漂亮的网站想发布到互联网上供大家参观，在没有公网IP的情况下该怎么实现呢？

还有的时候我们在对企业做渗透测试的时候，发现企业某台公网服务器只对公网开放了常见的80端口，而我们提权时需要用到的3389等端口没有对公网开放，这个时候又该怎么办呢？

解决这些问题的方式就是内网穿透了。

## NAPT原理

简单来说，在NAT网关上会有一张映射表，表上记录了内网向公网哪个IP和端口发起了请求，然后如果内网有主机向公网设备发起了请求，内网主机的请求数据包传输到了NAT网关上，那么NAT网关会修改该数据包的源IP地址和源端口为NAT网关自身的IP地址和任意一个不冲突的自身未使用的端口，并且把这个修改记录到那张映射表上。最后把修改之后的数据包发送到请求的目标主机，等目标主机发回了响应包之后，再根据响应包里面的目的IP地址和目的端口去映射表里面找到该转发给哪个内网主机。这样就实现了内网主机在没有公网IP的情况下，通过NAPT技术借助路由器唯一的一个公网IP来访问公网设备。

具体原理我到网上找了一张图片

![img](https://cy-1256894686.cos.ap-beijing.myqcloud.com/cy/2020-01-12-063528.jpg)

从这里我们可以看到，NAPT只解决了内网主机在没有公网IP的情况下如何访问公网主机的问题，但是并不能解决公网主机如何主动向内网主机发起请求的问题。

## 私有地址

在较早以前的 RFC 1918 文档中对私有地址有相关的说明。

因特网域名分配组织[IANA](https://link.zhihu.com/?target=https%3A//baike.baidu.com/item/IANA/2800158)组织（Internet Assigned Numbers Authority）保留了以下三个[IP地址](https://link.zhihu.com/?target=https%3A//baike.baidu.com/item/IP%E5%9C%B0%E5%9D%80/150859)块用于私有网络。

10.0.0.0 - 10.255.255.255 (10/8比特前缀)

172.16.0.0 - 172.31.255.255 (172.16/12比特前缀)

192.168.0.0 - 192.168.255.255 (192.168/16比特前缀)

我们可以看到其中有1个A类地址块，32个B类地址块和256个C类地址块。主流的家用路由器使用C类私有地址作为路由器LAN端的IP地址较多，所以我们可以看到路由器设置页面的IP一般都为192.168开头。

## 原因

先说说家庭宽带的情况吧。家庭宽带如果没有公网IP，那么意味着你在本机上监听的任何端口，都只能在本机网卡所在的网络中访问，这个网络一般是路由器LAN端所在的网络。如果没有做特定的映射规则，那么路由器WAN端所连接到的网络将无法正常访问该主机提供的服务。

如果这种情况下想要让WAN端（如果运营商为你分配了公网IP，那么WAN端所连接到的网络通常就是公网），那么需要在路由器上做端口映射。比如说路由器的LAN IP为192.168.1.1，WAN IP为23.23.23.23，我想让内网192.168.1.2主机的80端口提供的HTTP服务器直接能够在公网中通过[http://23.23.23.23](https://link.zhihu.com/?target=http%3A//23.23.23.23)访问，那么就要将192.168.1.2:80映射到23.23.23.23:80上。

但是通常情况下，运营商是不会给普通用户公网IP的。那么用这种方法映射，在公网仍然是无法访问的，因为你的路由器WAN端连接的又是运营商更上一级的路由器LAN端，严重一点，甚至是层层连接最后才到公网，这种行为称作流量穿透。国内某电，某动的宽带就有大量这种行为。通过流量穿透的方式来提供的宽带服务，看似便宜，实则影响很大，由于大家公用一个IP，可能会导致很多网站的反SPAM策略伤及无辜，或者内部为了节省带宽，使用缓存，导致一些不该缓存的敏感安全页面被缓存起来，甚至导致部分网站缓存失效完全打不开。

有的人发现，即使自己有公网IP，但是仍然无法通过常规方法架设服务器，这是怎么回事呢？这是运营商为了防止个人随意开设各种非法服务，也防止黑客通过扫描器进行抓鸡和批量扫描，将一些常用端口进行了封禁，比如说我们这的中国电信就将80，8080等端口封禁了。这样封禁，虽然一定程度上保证了我们的网络安全，比如说前段时间的勒索病毒正因为国内大部分用户没有独立的公网IP，并且操作系统最容易爆发漏洞的一些，135，139等端口被运营商封禁了，使得国内个人家庭电脑中招的概率小了很多；但是导致即使有公网IP，也无法使用常用端口向外网提供服务，只能更换到其他端口。这样有什么不好呢？比较典型的问题就是WEB网站默认使用80端口，那么在输入网址的时候可以不用带上端口号，显得比较美观。

## 解决方案

如果遇到了上述情况，我们该如何解决呢？

如果我们没有一台公网服务器，我们可以使用国内大名鼎鼎的“花生壳”，“nat123”等服务来实现，但是他们背后的原理是什么呢？

我们如果在自己拥有一台具有公网IP服务器的情况下，我们可以借助这台公网IP服务器提供服务。而具体又该怎么操作呢？

## 解决方案的实现

先假设我们自己有一台公网服务器，他的IP为45.45.45.45。我们又有一台内网服务器IP为23.23.23.23.我们现在想把23.23.23.23:80，即内网服务器上的HTTP服务开放到45.45.45.45上。

最简单粗暴的方式就是，我们可以直接将整个内网服务器环境在公网服务器上重新搭建一遍。

但是这样做很麻烦，我们有的时候并不想这样做，我们只是想简单的借助公网服务器的网络来发布一个内网服务。

前面我们通过NAPT原理得知：NAPT实现了内网主机在没有公网IP的情况下访问公网主机。那么我们可以这样做：假设公网IP为23.23.23.23，内网IP为192.168.1.2。公网主机先监听80端口，监听这个端口是用于向外部提供一个HTTP服务，80是WEB服务器的默认端口。同时其他任意一个端口（这里我们假设为7777），监听这个端口是用于让内网服务器主动连接进来打通一个隧道。接着内网再主动向公网主机的7777发起一个请求，这样内网就成功与公网主机建立了一个连接通道。然后当有任何客户端主动连接公网的80端口时，公网接收到连接请求之后马上把这连接请求通过先前建立好的隧道转发到内网主机，内网主机接收到来自隧道的数据包后再主动连接内网主机自身的80端口，连接成功之后将数据包原封不动地转发数据包给80端口，待HTTP服务器程序处理完这个数据包，生成了响应报文之后再原路转发回去，最终到达公网的80端口，然后返回给最开始请求公网服务器80端口的客户端。

看起来是不是比较绕呢？事实上大名鼎鼎的花生壳内网版以及nat123等内网穿透工具的原理基本就是如此，但是并不完全是这样。因为一个运输层端口只能同时提供一种服务，但是我们会发现花生壳这种内网穿透服务是借助一个公网IP同时给很多用户提供了服务，这是因为花生壳在流量转发这一层上并不是像我之前所说的原封不动的将报文进行转发，而是在转发之前加了一些控制协议的内容，用于指明该转发到哪个花生壳客户端所在的内网主机上。前者这种原封不动的转发方式通常叫做透明传输或者透明代理。

## 穿透防火墙

为了安全起见，通常会在网络中加入防火墙，防火墙有入站规则和出站规则。如果不是非常严格的安全管控，通常是不会设置出站规则的，但是入站规则一般都会设置的，比如说外部可以通过80端口传入内网的WEB服务器访问网页，但是不能通过3389端口登陆内网的远程桌面。

而在内网渗透的过程中碰到这种情况，我们也可以借助上面内网传统的方式实现穿透防火墙的入站规则。因为防火墙通常只拦截了入站，没有拦截出站，那么我们可以让内网服务器主动出站（主动连接到黑客的服务器），与黑客自己的服务器打通隧道，最终绕过防火墙连上3389远程桌面。

还有一种情况就是我们已经拿下了内网其中一台并没有做任何防火墙规则的白名单服务器，但是我们想连上内网另一台做了入站规则的目标服务器，那么我们可以让这台白名单服务器作为一个跳板，让他先监听自身任意一个端口，然后在有任何用户连上这个端口之后，白名单服务器就主动连上内网的目标服务器，然后借助这台白名单服务器打通黑客和目标服务器的连接隧道。

而在黑客工具中大名鼎鼎的lcx原理也就是如此，前者的实现是lcx的listen和slave命令，后者的实现是lcx的tran命令。